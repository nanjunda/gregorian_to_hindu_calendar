<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panchanga Insights | Cosmic Configuration</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Outfit:wght@300;500;700&display=swap"
        rel="stylesheet">
    <!-- Marked for markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        .insight-content {
            line-height: 1.8;
            font-size: 1.1rem;
            color: var(--text-white);
        }

        .insight-content h2,
        .insight-content h3 {
            color: var(--secondary);
            margin-top: 2rem;
            font-family: 'Outfit', sans-serif;
        }

        .insight-content p {
            margin-bottom: 1.5rem;
        }

        .insight-content strong {
            color: var(--secondary);
        }

        .back-link {
            display: inline-block;
            margin-top: 2rem;
            color: var(--text-muted);
            text-decoration: none;
            font-size: 0.9rem;
            transition: color 0.3s;
        }

        .back-link:hover {
            color: var(--secondary);
        }

        .loading-state {
            text-align: center;
            padding: 4rem;
        }

        /* 3D Visual Containers */
        .visual-block {
            margin: 2rem 0;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            overflow: hidden;
            position: relative;
            min-height: 400px;
        }

        .visual-iframe {
            width: 100%;
            height: 400px;
            border: none;
            display: block;
        }

        .visual-caption {
            padding: 1rem;
            background: rgba(13, 17, 23, 0.8);
            font-size: 0.85rem;
            color: var(--secondary);
            text-align: center;
            border-top: 1px solid var(--border-color);
        }

        .visual-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--text-muted);
            font-size: 0.9rem;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>Panchanga Insights</h1>
            <p id="config-title">Astronomical Configuration</p>
        </header>

        <main>
            <section class="card glass">
                <div id="loading-insights" class="loading-state">
                    <div class="spinner"></div>
                    <p>Consulting the Sages & Stars...</p>
                </div>
                <div id="insight-display" class="insight-content hidden">
                    <!-- AI Content will be injected here -->
                </div>
            </section>

            <a href="/" class="back-link">‚Üê Return to Converter</a>
        </main>

        <footer>
            <p>&copy; 2025 Hindu Panchanga Engine | AI Powered Insights</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            console.log("Insights page initialized.");

            // Priority 1: Data passed directly from server (v5.0 robust delivery)
            let insightData = {% if initial_data %}{{ initial_data | tojson | safe }}{% else %}null{% endif %};

        // Priority 2: Fallback to storage if page was refreshed or direct access
        if (!insightData) {
            console.log("No server-side data found, checking local storage...");
            const rawData = localStorage.getItem('lastPanchangaResult') || sessionStorage.getItem('lastPanchangaResult');
            if (rawData) {
                try { insightData = JSON.parse(rawData); } catch (e) { }
            }
        }

        const display = document.getElementById('insight-display');
        const loader = document.getElementById('loading-insights');
        const configTitle = document.getElementById('config-title');

        if (!insightData) {
            display.innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <p style="color: var(--secondary); font-weight: bold; font-size: 1.2rem;">‚ö†Ô∏è Astronomical Configuration Missing</p>
                        <p>The Wisdom Engine needs a specific moment in time to explain.</p>
                        <p style="margin-top: 1rem;"><strong>Please go back, run a conversion, then click Explore Insights.</strong></p>
                    </div>
                `;
            display.classList.remove('hidden');
            loader.classList.add('hidden');
            return;
        }

        configTitle.textContent = `${insightData.masa} ${insightData.samvatsara} | ${insightData.tithi}`;

        try {
            const response = await fetch('/api/ai-explain', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(insightData)
            });

            const result = await response.json();

            if (result.success) {
                let htmlContent = marked.parse(result.insight);

                // Apply Interactive Glossary (v5.0)
                const glossary = {
                    'epoch': 'A fixed point in time used as a reference point for calculating astronomical events or calendar dates.',
                    'jovian': 'Relating to the planet Jupiter. In Panchanga, the Samvatsara cycle is based on Jupiter\'s orbital period.',
                    'precession': 'The slow, conical motion of Earth\'s axis, which causes the position of the stars to appear to shift.',
                    'sidereal': 'Measured relative to the distant stars, rather than the Sun.',
                    'ayanamsha': 'The angular difference between the Tropical (fixed seasons) and Sidereal (fixed stars) zodiacs.',
                    'solstice': 'The time when the Sun reaches its highest or lowest point in the sky at noon.',
                    'equinox': 'The time when day and night are of approximately equal length.'
                };

                for (const [term, definition] of Object.entries(glossary)) {
                    const regex = new RegExp(`\\b${term}\\b`, 'gi');
                    htmlContent = htmlContent.replace(regex, (match) => {
                        return `<span class="highlight-term">${match}<span class="tooltip-bubble">${definition}</span></span>`;
                    });
                }

                // Dynamic 3D Tag Injection (v5.0 Penthouse Edition)
                const renderTags = {
                    'ZODIAC_COMPARISON': {
                        url: '/visuals/zodiac-comparison',
                        caption: 'Interactive Zodiac Aligner',
                        significance: 'This simulation demonstrates the fundamental difference between Modern (Tropical) and Hindu (Sidereal) astronomy. As the Earth wobbles over thousands of years, the seasons (Western signs) shift away from the actual star clusters (Rashis). The current Ayanamsa gap is approximately 24 degrees.'
                    },
                    'MOON_PHASE_3D': {
                        url: '/visuals/moon-phase',
                        caption: 'Tithi Phase Protractor',
                        significance: 'A Tithi is a specialized unit of time defined as a 12¬∞ angular separation between the Sun and the Moon from Earth\'s perspective. This "Phase Protractor" calculates the precise Tithi and Paksha based on that geometric angle.'
                    },
                    'PRECESSION_WOBBLE': {
                        url: '/visuals/precession',
                        caption: 'The Earth\'s Great Wobble',
                        significance: 'Earth spins like a wobbling top. This 25,800-year cycle, called Precession, is why the stars appear to shift slowly over centuries, necessitating the Ayanamsa correction in the Panchanga.'
                    },
                    'CONSTELLATION_MAP': {
                        url: '/visuals/constellations',
                        caption: 'Sky Focus: Lunar Tracking',
                        significance: 'The Sky Focus represents the Moon\'s coordinates against the galactic background. While the stars move across the night sky, the Moon physically passes through specific star clusters called Nakshatras. The highlight shows the boundary of the Moon\'s "home" for the next 24 hours.'
                    }
                };

                function parseVisualTags(content) {
                    return content.replace(/\[\[RENDER:(.*?)\]\]/g, (match, tagName) => {
                        const tag = renderTags[tagName.trim()];
                        if (tag) {
                            return `
                                <div class="visual-block-wrapper" style="margin: 2.5rem 0;">
                                    <div class="visual-block card glass" style="margin-bottom: 0;">
                                        <div class="visual-loading">Launching 3D Module...</div>
                                        <iframe class="visual-iframe" src="${tag.url}?samvatsara=${encodeURIComponent(insightData.samvatsara)}&tithi=${encodeURIComponent(insightData.tithi)}&rashi=${encodeURIComponent(insightData.rashi?.name || 'Leo')}" onload="this.previousElementSibling.style.display='none'"></iframe>
                                        <div class="visual-caption">üñ•Ô∏è ${tag.caption}</div>
                                    </div>
                                    <div class="visual-significance" style="padding: 1rem; background: rgba(0, 210, 255, 0.05); border-left: 3px solid var(--secondary); font-size: 0.95rem; line-height: 1.6; color: var(--text-white);">
                                        <strong>Significance:</strong> ${tag.significance}
                                    </div>
                                </div>
                            `;
                        }
                        return `<p style="color:red">[System: Rendering ${tagName} failed - Module not found]</p>`;
                    });
                }

                htmlContent = parseVisualTags(htmlContent);

                display.innerHTML = htmlContent;
                display.classList.remove('hidden');
                loader.classList.add('hidden');
            } else {
                display.innerHTML = `<p>Error generating insights: ${result.error}</p>`;
                display.classList.remove('hidden');
                loader.classList.add('hidden');
            }
        } catch (error) {
            display.innerHTML = "<p>Failed to connect to the Wisdom Engine. Please try again later.</p>";
            display.classList.remove('hidden');
            loader.classList.add('hidden');
        }
        });
    </script>
</body>

</html>