<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Interactive 3D Zodiac with Moon</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            background: #05070c;
            overflow: hidden;
        }

        #description {
            position: absolute;
            bottom: 20px;
            width: 100%;
            text-align: center;
            color: #00d2ff;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            text-shadow: 0 0 10px rgba(0, 210, 255, 0.5);
            pointer-events: none;
            padding: 0 20px;
            box-sizing: border-box;
        }
    </style>
    <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js"
    }
  }
  </script>
</head>

<body>
    <div id="description">Interactive 3D Zodiac belt with symbols and names. Moon is shown in the foreground with slow
        orbital motion and simulated phases. Use mouse to rotate and zoom the view.</div>
    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/controls/OrbitControls.js';

        // Get Rashi from URL for focus
        const params = new URLSearchParams(window.location.search);
        const targetRashi = (params.get('rashi') || 'Simha').split(' (')[0].trim();

        // Mapping for focus
        const rashiToModern = {
            'Mesha': 'Aries', 'Vrishabha': 'Taurus', 'Mithuna': 'Gemini',
            'Kataka': 'Cancer', 'Simha': 'Leo', 'Kanya': 'Virgo',
            'Tula': 'Libra', 'Vrishchika': 'Scorpio', 'Dhanus': 'Sagittarius',
            'Makara': 'Capricorn', 'Kumbha': 'Aquarius', 'Meena': 'Pisces'
        };

        // Scene
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x05070c, 0.0008);

        // Camera
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 2000);
        camera.position.set(0, 150, 450);

        // Renderer
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.body.appendChild(renderer.domElement);

        // Controls
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.screenSpacePanning = true;

        // Dense starfield
        const starGeo = new THREE.BufferGeometry();
        const starCount = 15000;
        const starPos = [];
        for (let i = 0; i < starCount; i++) {
            const r = 1200 * Math.random();
            const theta = Math.random() * Math.PI * 2;
            const phi = Math.acos(2 * Math.random() - 1);
            starPos.push(r * Math.sin(phi) * Math.cos(theta), r * Math.sin(phi) * Math.sin(theta), r * Math.cos(phi));
        }
        starGeo.setAttribute('position', new THREE.Float32BufferAttribute(starPos, 3));
        const starMat = new THREE.PointsMaterial({ color: 0xffffff, size: 0.8, sizeAttenuation: true });
        scene.add(new THREE.Points(starGeo, starMat));

        // Zodiac 3D band
        const bandRadius = 250;
        const bandThickness = 12;
        const bandGeom = new THREE.TorusGeometry(bandRadius, bandThickness, 32, 128);
        const bandMat = new THREE.MeshStandardMaterial({
            color: 0x996633,
            emissive: 0x442200,
            emissiveIntensity: 0.4,
            metalness: 0.2,
            roughness: 0.6,
            transparent: true,
            opacity: 0.25
        });
        const zodiacBand = new THREE.Mesh(bandGeom, bandMat);
        zodiacBand.rotation.x = Math.PI / 2;

        // Main container for rotation
        const mainGroup = new THREE.Group();
        mainGroup.add(zodiacBand);
        scene.add(mainGroup);

        // Zodiac symbols + names
        const zodiac = [
            { name: 'Aries', symbol: '♈' }, { name: 'Taurus', symbol: '♉' }, { name: 'Gemini', symbol: '♊' },
            { name: 'Cancer', symbol: '♋' }, { name: 'Leo', symbol: '♌' }, { name: 'Virgo', symbol: '♍' },
            { name: 'Libra', symbol: '♎' }, { name: 'Scorpio', symbol: '♏' }, { name: 'Sagittarius', symbol: '♐' },
            { name: 'Capricorn', symbol: '♑' }, { name: 'Aquarius', symbol: '♒' }, { name: 'Pisces', symbol: '♓' }
        ];

        let targetIndex = 4; // Default Leo
        const modernTarget = rashiToModern[targetRashi] || 'Leo';
        zodiac.forEach((z, i) => { if (z.name === modernTarget) targetIndex = i; });

        const symbolGroup = new THREE.Group();
        zodiac.forEach((z, i) => {
            const angle = (i / 12) * Math.PI * 2;
            const x = bandRadius * Math.cos(angle);
            const zpos = bandRadius * Math.sin(angle);
            const canvas = document.createElement('canvas');
            canvas.width = 1024; canvas.height = 1024;
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, 1024, 1024);

            const isTarget = (i === targetIndex);
            ctx.fillStyle = isTarget ? '#ffcc00' : '#ffd27d';
            ctx.font = 'bold 360px serif'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText(z.symbol, 512, 420);

            ctx.font = 'bold 54px sans-serif';
            ctx.fillStyle = isTarget ? '#00d2ff' : '#ffffff';
            ctx.fillText((isTarget ? (targetRashi.toUpperCase() + " / ") : "") + z.name.toUpperCase(), 512, 620);

            const texture = new THREE.CanvasTexture(canvas);
            const spriteMat = new THREE.SpriteMaterial({ map: texture, transparent: true });
            const sprite = new THREE.Sprite(spriteMat);
            sprite.position.set(x, 25, zpos);
            sprite.scale.set(70, 70, 1);
            symbolGroup.add(sprite);
        });
        mainGroup.add(symbolGroup);

        // Rotate mainGroup so the target Rashi is facing the camera
        // Band is in XZ plane. Angle 0 is X=250, Z=0.
        // Camera is at Z=450. We want Z=250 for the target.
        // So angle i should be at PI/2.
        mainGroup.rotation.y = - (targetIndex / 12) * Math.PI * 2 + Math.PI / 2;

        // Lighting
        scene.add(new THREE.AmbientLight(0xffffff, 0.45));
        const dir = new THREE.DirectionalLight(0xffcc88, 0.8); dir.position.set(300, 600, 400); scene.add(dir);

        // Moon (foreground with phase animation and 5.1 deg tilt)
        const moonGeom = new THREE.SphereGeometry(20, 64, 64);
        const moonMat = new THREE.MeshStandardMaterial({ color: 0xd9d9d9, roughness: 0.9, metalness: 0 });
        const moon = new THREE.Mesh(moonGeom, moonMat);
        const moonOrbit = new THREE.Group();
        moonOrbit.rotation.x = THREE.MathUtils.degToRad(5.1);
        moon.position.set(0, 50, 100);
        moonOrbit.add(moon);
        scene.add(moonOrbit);
        const sunLight = new THREE.DirectionalLight(0xffffff, 1.0); sunLight.position.set(-500, 200, 300); scene.add(sunLight);

        // Animate
        let moonAngle = 0;
        function animate() {
            requestAnimationFrame(animate);
            mainGroup.rotation.y += 0.0003;
            moonAngle += 0.002;
            moon.position.x = 80 * Math.cos(moonAngle);
            moon.position.z = 120 + 40 * Math.sin(moonAngle);
            controls.update();
            renderer.render(scene, camera);
        }
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>

</html>