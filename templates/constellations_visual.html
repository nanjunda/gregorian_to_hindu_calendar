<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Constellation Explorer</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #0b0e14;
            color: #fff;
            font-family: 'Inter', sans-serif;
        }

        #ui {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(0, 0, 0, 0.6);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #333;
        }

        .highlight {
            color: #ffcc00;
            font-weight: 700;
        }
    </style>
</head>

<body>
    <div id="ui">
        <div id="target-info">Sky Focus: <span class="highlight" id="rashi-name">Loading...</span></div>
        <div style="font-size: 0.75rem; color: #888; margin-top: 5px;">Showing Sidereal (fixed star) coordinates.</div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        const params = new URLSearchParams(window.location.search);
        const rashi = params.get('rashi') || 'Leo';
        document.getElementById('rashi-name').innerText = rashi;

        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 1, 5000);
        camera.position.set(0, 0, 1);

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const textureLoader = new THREE.TextureLoader();
        const zodiacTexture = textureLoader.load('/static/images/zodiac_map.jpg');

        // Background Plane (The Map)
        const bgGeo = new THREE.PlaneGeometry(3000, 1000);
        const bgMat = new THREE.MeshBasicMaterial({ map: zodiacTexture, transparent: true });
        const bgMesh = new THREE.Mesh(bgGeo, bgMat);
        bgMesh.position.z = -1000;
        scene.add(bgMesh);

        // Hindu Rashi to Modern Constellation Mapping
        const rashiMap = {
            'Mesha': { name: 'Aries', idx: 0 },
            'Vrishabha': { name: 'Taurus', idx: 1 },
            'Mithuna': { name: 'Gemini', idx: 2 },
            'Kataka': { name: 'Cancer', idx: 3 },
            'Simha': { name: 'Leo', idx: 4 },
            'Kanya': { name: 'Virgo', idx: 5 },
            'Tula': { name: 'Libra', idx: 6 },
            'Vrishchika': { name: 'Scorpio', idx: 7 },
            'Dhanus': { name: 'Sagittarius', idx: 8 },
            'Makara': { name: 'Capricorn', idx: 9 },
            'Kumbha': { name: 'Aquarius', idx: 10 },
            'Meena': { name: 'Pisces', idx: 11 }
        };

        const cleanRashi = rashi.split(' (')[0].trim();
        const rashiInfo = rashiMap[cleanRashi] || { name: 'Unknown', idx: 4 }; // Default Leo
        const modernName = rashiInfo.name;

        // Pan map based on Rashi index (Mesha=0 is far left, Meena=11 is far right)
        // Map width is 3000, so each sign is 250 wide. 
        // We want Mesha (idx 0) to be at the center (x=0)? 
        // If Mesha is at the far left of the image, we shift image to the RIGHT.
        const rashiWidth = 3000 / 12;
        const startX = 1500 - (rashiWidth / 2); // Far Left segment center
        bgMesh.position.x = startX - (rashiInfo.idx * rashiWidth);

        let displayLabel = rashi;
        if (modernName && !rashi.includes(`(${modernName})`)) {
            displayLabel = `${cleanRashi} (${modernName})`;
        }
        document.getElementById('rashi-name').innerText = displayLabel;

        // Helper for 3D Labels
        function createLabel(text, color) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 512; canvas.height = 128;
            ctx.fillStyle = color; ctx.font = 'bold 48px Inter, Arial';
            ctx.textAlign = 'center';
            ctx.fillText(text, 256, 80);
            const tex = new THREE.CanvasTexture(canvas);
            const mat = new THREE.SpriteMaterial({ map: tex });
            const sprite = new THREE.Sprite(mat);
            sprite.scale.set(300, 75, 1);
            return sprite;
        }

        // Add Label directly to Sky
        const rashiLabel = createLabel(displayLabel.toUpperCase(), '#ffcc00');
        rashiLabel.position.set(0, 150, -500);
        scene.add(rashiLabel);

        // The Moon (Foreground)
        const moonGeo = new THREE.SphereGeometry(8, 32, 32); // even smaller
        const moonMat = new THREE.MeshBasicMaterial({ color: 0xffffff });
        const moon = new THREE.Mesh(moonGeo, moonMat);
        moon.position.set(0, 0, -200);
        scene.add(moon);

        const moonLabel = createLabel('MOON', '#ffffff');
        moonLabel.position.set(0, 25, 0);
        moon.add(moonLabel);

        // Core interactive rotation (subtle)
        let mouseX = 0, mouseY = 0;
        window.addEventListener('mousemove', (e) => {
            mouseX = (e.clientX - window.innerWidth / 2) * 0.05;
            mouseY = (e.clientY - window.innerHeight / 2) * 0.05;
        });

        function animate() {
            requestAnimationFrame(animate);
            camera.rotation.y += (mouseX * 0.0001 - camera.rotation.y) * 0.02;
            camera.rotation.x += (mouseY * 0.0001 - camera.rotation.x) * 0.02;
            renderer.render(scene, camera);
        }
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>

</html>