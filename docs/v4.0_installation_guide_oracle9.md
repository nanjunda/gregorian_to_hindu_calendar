# v4.0 Installation Guide: Oracle Linux 9 VM (OCI)

This guide provides step-by-step instructions for deploying the Hindu Panchanga Converter v4.0 (Cosmic Context) on an Oracle Linux 9 VM in Oracle Cloud.

## Prerequisites
- Oracle Linux 9 VM with root/sudo access.
- Internet connectivity to download dependencies.
- Git installed on the VM.

## Installation Steps

### 1. Stop Existing Service (If applicable)
If you have a previous version installed, stop the service to prevent conflicts:
```bash
sudo systemctl stop panchanga || true
```

### 2. Clone the Cosmic Branch
Clone the latest v4.0 code from the `cosmic` branch:
```bash
# Navigate to your home directory
cd ~

# Remove old repository folder if it exists
rm -rf gregorian_to_hindu_calendar

# Clone the repository and switch to the cosmic branch
git clone -b cosmic https://github.com/nanjunda/gregorian_to_hindu_calendar.git
```

### 3. Run the Automated Deployment
The `deploy.sh` script handles everything: SSL generation, Nginx on Port 58921, Firewall rules, SELinux hardening, and Systemd setup.
```bash
cd gregorian_to_hindu_calendar

# Grant execution permissions
chmod +x deploy.sh

# Run the deployment script with sudo
sudo ./deploy.sh
```

### 4. Verify Access
The application will be available over HTTPS on the custom security port **58921**:
- **URL**: `https://[YOUR_VM_PUBLIC_IP]:58921`
- **SSL Notice**: Since we use self-signed certificates, the browser will show a warning. Click **Advanced -> Proceed** to access the site.

## Post-Installation Verification
1. **Panchanga Lookup**: Perform a conversion to ensure basic calculations are working.
2. **Cosmic Visuals**: Scroll down to see:
   - "Your Sky at Birth" (Ecliptic Chart)
   - "Planetary Alignment" (Solar System Map)
3. **Log Check**: If images don't load, check the application logs:
   ```bash
   journalctl -u panchanga -f
   ```

## Troubleshooting

### Gunicorn "Worker failed to boot"
If the service fails to start with a "Worker failed to boot" error:
1. **Missing Libraries**: Ensure `libX11` and `freetype` are installed (handled by the updated `deploy.sh`).
2. **Missing Data Files**: Skyfield requires ephemeris files. The updated `deploy.sh` pre-downloads them. If they are still missing, run:
   ```bash
   cd /opt/panchanga
   sudo ./venv/bin/python3 -c "from skyfield.api import load; load('de421.bsp'); load.timescale()"
   sudo chown opc:nginx *.bsp *.dat *.tdb *.preds
   ```
3. **Manual Debug**: Run the app manually to see the exact traceback:
   ```bash
   cd /opt/panchanga
   ./venv/bin/gunicorn --workers 1 --bind 127.0.0.1:8000 app:app
   ```
 
## Security & Maintenance
- **Port 58921**: Ensure that the Oracle Cloud Security List (Ingress Rules) for your VCN allows TCP traffic on Port 58921.
- **Log Rotation**: Logs are automatically rotated hourly via the script settings in `/etc/logrotate.d/panchanga`.
